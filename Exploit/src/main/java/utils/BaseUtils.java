package utils;

import com.google.gson.*;
import com.jayway.restassured.RestAssured;
import com.jayway.restassured.http.ContentType;
import com.jayway.restassured.response.Response;

import org.apache.poi.util.ArrayUtil;

import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.*;

public class BaseUtils {

    public static List<String> dataFormats, tenants, channels;
    public static String defaultDataPreparation;
    public static int totalNumberOfEntities, numberOfEntitiesPerFile;
    public static JsonParser jsonParser = new JsonParser();
    public static Map<String, List<String>> dataparamsMap = new HashMap<>();

    public static String readFileAsString(String fileName) throws Exception {
        String data = "";
        data = new String(Files.readAllBytes(Paths.get(fileName)));
        return data;
    }

    public static void main(String[] args) {
        try {
            JsonObject configObject = new JsonObject();
            configObject = jsonParser.parse(readFileAsString(
                    System.getProperty("user.dir") + "/src/main/java/configs/config.json")).getAsJsonObject();
            dataFormats = convertJsonArrayToArrayList(JsonRecord.findArray(configObject, "params.globalParams.dataFormats"));
            tenants = convertJsonArrayToArrayList(JsonRecord.findArray(configObject, "params.globalParams.tenants"));
            channels = convertJsonArrayToArrayList(JsonRecord.findArray(configObject, "params.globalParams.channels"));

            defaultDataPreparation = JsonRecord.getValue(configObject, "params.dataParams.defaultDataPreparation");

            if (defaultDataPreparation.equalsIgnoreCase("global")) {
                totalNumberOfEntities = Integer.parseInt(JsonRecord.getValue(configObject, "params.dataParams.totalNumberOfEntities"));
                numberOfEntitiesPerFile = Integer.parseInt(JsonRecord.getValue(configObject, "params.dataParams.numberOfEntitiesPerFile"));
            } else {
                for (String individualFormats : dataFormats) {
                    String totalNumberOfEntitiesPerFormat = JsonRecord.getValue(configObject, String.format("params.dataParams.%s[0].totalNumberOfEntities", individualFormats));
                    String numberOfEntitiesPerFilePerFormat = JsonRecord.getValue(configObject, String.format("params.dataParams.%s[0].numberOfEntitiesPerFile", individualFormats));
                    List<String> helperList = new ArrayList<>();

                    /*if(!totalNumberOfEntitiesPerFormat.equalsIgnoreCase("NA") && !numberOfEntitiesPerFilePerFormat.equalsIgnoreCase("NA")){

                    }*/

                    if (!totalNumberOfEntitiesPerFormat.equalsIgnoreCase("NA")) {
                        helperList.add(individualFormats);
                        helperList.add(totalNumberOfEntitiesPerFormat);
                        for (String individualTenants : tenants) {
                            dataparamsMap.put(individualTenants, helperList);
                         }
                    }

                    if (!numberOfEntitiesPerFilePerFormat.equalsIgnoreCase("NA")) {

                        /*helperList.add(individualFormats);
                        helperList.add(numberOfEntitiesPerFilePerFormat);*/
                        for (String individualTenants : tenants) {
                            //dataparamsMap.put(individualTenants, helperList);
                            dataparamsMap.get(individualTenants).add(numberOfEntitiesPerFilePerFormat);
                        }
                    }

                    //if(totalNumberOfEntitiesPerFormat)
                    for (String individualTenants : tenants) {
                        String individualtotalNumberOfEntities = JsonRecord.getValue(configObject, String.format("params.dataParams.%s[0]."));
                    }
                    //dataparamsMap.put(individualFormats, JsonRecord.findArray(configObject, "params.dataparams." + individualFormats));
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static List<String> convertJsonArrayToArrayList(JsonArray jsonArray) {
        List<String> convertedArrayList = new ArrayList<>();
        convertedArrayList = new Gson().fromJson(jsonArray, List.class);
        return convertedArrayList;
    }

      public JsonObject invokeRestAPI(String instnaceName, String webPort, String tenant, String service, String api, String requestBody) {
        Response getResponse = null;
        String url = String.format("http://manage.%s.riversand-dataplatform.com:%s/%s/api/%s/%s", instnaceName, webPort, tenant, service, api);
        try {
            getResponse = RestAssured.given()
                    .contentType(ContentType.JSON)
                    .header("x-rdp-version", "8.1")
                    .header("x-rdp-clientId", "rdpclient")
                    .header("x-rdp-tenantId:", tenant)
                    .header("x-rdp-ownershipData", "Nike")
                    .header("x-rdp-userId", "system_user")
                    .header("x-rdp-userName", "System User")
                    .header("x-rdp-firstName", "System")
                    .header("x-rdp-lastName", "User")
                    .header("x-rdp-userEmail", "system.user@riversand.com")
                    .header("x-rdp-userRoles", "[\"admin\"]")
                    .body(requestBody)
                    .when()
                    .post(url);

        } catch (Exception ex) {
            ex.printStackTrace();
            return null;
        }
        return new JsonParser().parse(getResponse.getBody().asString()).getAsJsonObject();
    }

    //with clientid
    public JsonObject invokeRestAPI(String instnaceName, String webPort, String tenant, String service, String api, String requestBody, String clientId) {
        Response getResponse = null;
        String url = String.format("http://manage.%s.riversand-dataplatform.com:%s/%s/api/%s/%s", instnaceName, webPort, tenant, service, api);
        try {
            getResponse = RestAssured.given()
                    .contentType(ContentType.JSON)
                    .header("x-rdp-version", "8.1")
                    .header("x-rdp-clientId", clientId)
                    .header("x-rdp-tenantId:", tenant)
                    .header("x-rdp-ownershipData", "Nike")
                    .header("x-rdp-userId", "system_user")
                    .header("x-rdp-userName", "System User")
                    .header("x-rdp-firstName", "System")
                    .header("x-rdp-lastName", "User")
                    .header("x-rdp-userEmail", "system.user@riversand.com")
                    .header("x-rdp-userRoles", "[\"admin\"]")
                    .body(requestBody)
                    .when()
                    .post(url);

        } catch (Exception ex) {
            ex.printStackTrace();
            return null;
        }
        return new JsonParser().parse(getResponse.getBody().asString()).getAsJsonObject();
    }

    public static void testharshith(){
        
    }
}
