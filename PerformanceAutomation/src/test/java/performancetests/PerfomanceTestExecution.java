package performancetests;

import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.codehaus.plexus.util.FileUtils;
import org.testng.annotations.Test;
import utilities.*;

import java.io.*;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.regex.Pattern;

/**
 * Created by harshithgn on 12/7/2017.
 */
@SuppressWarnings("all")
public class PerfomanceTestExecution {

    RiversandMaster objRiversandMaster = new RiversandMaster();
    CreateEntityJSON objCreateEntityJSON = new CreateEntityJSON();
    RestAssuredCall objRestAssuredCall = new RestAssuredCall();
    CopyPasteFiles objCopyPasteFiles = new CopyPasteFiles();
    ReadConfig objReadConfig = new ReadConfig();
    MailEngine objMailEngine = new MailEngine();
    static List<String> reportGen = new ArrayList<String>();
    static List<String> reportGenTime = new ArrayList<String>();
    static List<String> actualCount = new ArrayList<String>();
    ReportGenerator objWriteExcel = new ReportGenerator();
    List<String> mailRecipients = new ArrayList<String>();
    String masterFilePath = System.getProperty("user.dir") + "\\inputFiles\\Master.xls";
    HSSFWorkbook workbook = null;
    String kinesisCommand, backDirName, logFileName, logFileNameTimeStamp = null;
    Date now = new Date();
    DateFormat dateFormat = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss");
    Date perfStartTime = null;
    Date perfEndTime = null;
    long lStartTime;
    List<String> instanceDetails = new ArrayList<String>();



    @Test
    public void startPerformanceTests() throws Exception {
        try {
            FileInputStream inputStream;

            inputStream = new FileInputStream(new File(masterFilePath));
            workbook = new HSSFWorkbook(inputStream);

            HSSFSheet sheet1 = objRiversandMaster.readExcelWorkbook("inputFiles\\Master.xls", "Performance Test Suite");
            int perfRowCount = objRiversandMaster.getRowCount("Performance Test Suite", workbook);

            mailRecipients = objReadConfig.getMailRecipients(0);
            logFileName = new SimpleDateFormat("dd_MMM_yyyy_HH_mm_ss_aa").format(Calendar.getInstance().getTime());
            logFileNameTimeStamp = objReadConfig.appConfigStatus("Instance") + "_" + logFileName + ".html";
            logFileName = System.getProperty("user.dir") + "\\testReport\\logFiles\\" + logFileNameTimeStamp;

            File file = new File(logFileName);
            if (!file.exists()) {
                file.createNewFile();
            }

            if(objReadConfig.getHelpContent().get(5).trim().equalsIgnoreCase("Yes")) {
                instanceDetails = objReadConfig.getHelpContent();
                objMailEngine.testStartMail(logFileNameTimeStamp, mailRecipients, instanceDetails);
            }


            for (int i = 1; i <= perfRowCount; i++) {
                HSSFRow row = sheet1.getRow(i);
                String executionMode = row.getCell(0).toString();
                if (executionMode.equalsIgnoreCase("Yes")) {   //if execution mode is yes then read row and continue

                    backDirName = new SimpleDateFormat("dd_MM_yyyy_HH_mm").format(Calendar.getInstance().getTime());
                    String sourceExcelPath = System.getProperty("user.dir") + "\\inputFiles\\";
                    String destExcelPath = System.getProperty("user.dir") + "\\inputFilesBackup\\" + backDirName + "\\";
                    objCopyPasteFiles.copPasteFiles(sourceExcelPath, destExcelPath);

                    List<String> queryBuilder = new ArrayList<String>();
                    List<String> requestBuilder = new ArrayList<String>();

                    queryBuilder = objRiversandMaster.readQueryBuilder("Performance Test Suite", i, workbook);
                    requestBuilder = objRiversandMaster.readRequstBuilder("JSON Data", workbook, queryBuilder.get(0));
                    kinesisCommand = queryBuilder.get(3);  //kinesis kit query
                    kinesisCommand.replace("\"", "\"");
                    if (kinesisCommand != null) {
                        String p1=System.getProperty("user.dir") + "\\rsKinesisKit\\" + queryBuilder.get(1).trim().toString();

                        FileUtils.cleanDirectory(p1);
                        objCreateEntityJSON.generateEntityJson(queryBuilder.get(2), "rsKinesisKit\\" + queryBuilder.get(1), i, logFileName);   // call method to generate create entity json  //get(2) excel file name for json generation

                        String sourceJSONInPath = p1;
                        String destJSONOutExcelPath = System.getProperty("user.dir") + "\\rsKinesisKit\\inputBackup\\" + backDirName + "\\";
                        objCopyPasteFiles.copPasteFiles(sourceJSONInPath, destJSONOutExcelPath);

                        BufferedWriter writer = new BufferedWriter(new FileWriter(System.getProperty("user.dir") + "\\rsKinesisKit\\BATFiles\\" + queryBuilder.get(0).replace(" ", "") + ".bat"));   //create batch file
                        writer.write(kinesisCommand + System.lineSeparator() + "exit");  //write kinesis command to the above created batch file
                        writer.close();  //close the batch file

                        perfStartTime = Calendar.getInstance().getTime();  // start time before perfromance is commenced
                        lStartTime = Instant.now().getEpochSecond();

                        String command = "cmd /c start cmd.exe /k \"echo Kinesis command is executing... && cd rsKinesisKit\\ && " + System.getProperty("user.dir") + "\\rsKinesisKit\\BATFiles\\" + queryBuilder.get(0).replace(" ", "") + ".bat\"";  //open cmd and execute batch file to create entity through integrations
                        Process process = Runtime.getRuntime().exec(command);
                        Thread.sleep(10000);

                        int get1stAPITime = Integer.parseInt(queryBuilder.get(4)) * 60 * 1000;  //get wait time
                        int poolingInterval = Integer.parseInt(queryBuilder.get(5)) * 1000;  //get pooling interval time

                        Thread.sleep(get1stAPITime);
                        int restAssuredAPICount = objRestAssuredCall.callRestAssured(queryBuilder.get(0), poolingInterval, requestBuilder, lStartTime, queryBuilder, logFileName);

                        perfEndTime = Calendar.getInstance().getTime();
                        String timeTaken = objRiversandMaster.diffBetweenTwoDates(perfStartTime, perfEndTime);
                        String addToList = queryBuilder.get(0).trim().toString()+"||"+timeTaken;
                        reportGen.add(addToList);
                        reportGenTime.add(backDirName);
                        //int restAssuredAPICount = objRestAssuredCall.callRestAssured(queryBuilder.get(0), poolingInterval, requestBuilder, lStartTime, queryBuilder);
                        String actualAndExpectedCount = requestBuilder.get(4) + "||" + restAssuredAPICount;
                        actualCount.add(actualAndExpectedCount);
                    }
                }
            }
        }catch(Exception e){
            e.printStackTrace();
            objMailEngine.failureMail(mailRecipients, e.toString());
        } finally {
            if(reportGen.size()!= 0)
            {
                String fName = objWriteExcel.writeToExcel(reportGen, reportGenTime, actualCount);
                if(objReadConfig.appConfigStatus("SendEmail").equalsIgnoreCase("YES")) {
                    objMailEngine.successMail(fName, mailRecipients);
                }
            }
        }
    }
}