package utilities;

import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.openxml4j.opc.OPCPackage;

import javax.json.Json;
import javax.json.stream.JsonGenerator;
import java.io.*;
import java.util.List;
import java.util.regex.Pattern;

/**
 * Created by harshithgn on 12/7/2017.
 */
public class CreateEntityJSON {
    RiversandMaster objRiversandMaster = new RiversandMaster();

    public void generateEntityJson(String filePath, String jsonFolderGenPath, int masterRowCount, String logFileName) throws Exception {

        for (int nf = 1; nf <= 1; nf++) {
            String excelFilePath = System.getProperty("user.dir") + "\\inputfiles\\" + filePath;

            HSSFWorkbook workbook = null;
            FileInputStream inputStream;


            inputStream = new FileInputStream(new File(excelFilePath));
            workbook = new HSSFWorkbook(inputStream);


            FileWriter writer = null;
            int metadataRowCountSku = objRiversandMaster.getRowCount("skuSheet", workbook);
            int columCountSku = objRiversandMaster.getColCount("skuSheet", workbook);

            List<String> ExcelMetadata = null;
            JsonGenerator generator = null;
            int temp = 1;
            int skuRowCount = 1;
            int fName = 1;
            objRiversandMaster.logStatus(logFileName,"Creating jsons...!");
            System.out.println("Creating jsons...!");
            writer = new FileWriter(System.getProperty("user.dir")
                    + "\\" + jsonFolderGenPath + "Sku1k_" + fName + ".json");   //write input json in jsonFolderGenPath

            generator = Json.createGenerator(writer);
            generator.writeStartArray();

            for (; skuRowCount <= metadataRowCountSku; skuRowCount++, temp++) {

                ExcelMetadata = objRiversandMaster.ReadMetadata("skuSheet", skuRowCount, workbook);
                List<String> jsonGenaratorPath = objRiversandMaster.readQueryBuilder("Performance Test Suite", masterRowCount, workbook);

                generator.writeStartObject() // Indicates the start of an
                        // JSON object

                        .writeStartObject("entity") // Start of entity

                        .writeStartObject("data") // Start of data

                        .writeStartArray("contexts")

                        .writeStartObject()

                        .writeStartObject("context")

                        .write("classification", ExcelMetadata.get(2).toString().split(Pattern.quote("$"))[1])

                        .write("taxonomy", ExcelMetadata.get(1).toString().split(Pattern.quote("$"))[1])

                        .writeEnd()// end context

                        .writeEnd()

                        .writeEnd();

                generator.writeStartObject("attributes"); // Start of
                // attribute
                // object

                for (int i = 3; i <= columCountSku -2; i++) {
                    boolean isInteger = false;
                    String hdrVal = (ExcelMetadata.get(i).toString().split(java.util.regex.Pattern.quote("$"))[0]
                            .trim());
                    String attrVal = (ExcelMetadata.get(i).toString().split(java.util.regex.Pattern.quote("$"))[1]
                            .trim());
                    String rmvSpace = hdrVal.replace(" ", "");
                    String rmvSpclChar = rmvSpace.replaceAll("[^a-zA-Z0-9_]", "");
                    String rmvSpclChar1 = rmvSpclChar.replace("_", "");
                    String lwrCase = rmvSpclChar1.toLowerCase();

                    generator.writeStartObject(lwrCase)// Start attribute

                            .writeStartArray("values");

                    if (!attrVal.contains("||")) {
                        generator.writeStartObject().write("locale", "en-US").write("source", "internal")
                                .write("value", attrVal).writeEnd();// end
                        // after
                        // values
                    } else {
                        String[] valArry = attrVal.split(java.util.regex.Pattern.quote("||"));
                        for (int r = 0; r < valArry.length; r++) {
                            generator.writeStartObject().write("locale", "en-US").write("source", "internal")
                                    .write("value", valArry[r]).writeEnd();// end
                            // after
                            // values
                        }
                    }
                    generator.writeEnd()// values End
                            .writeEnd();// endAttributename
                }

                generator.writeEnd() // End of attribute object

                        .writeEnd() // data end

                        .write("type",
                                ExcelMetadata.get(0).toString().split(java.util.regex.Pattern.quote("$"))[1].trim())

                        .write("id", "")

                        .writeEnd() // End of entity

                        .writeEnd(); // End of Json Object

                if (temp == 20) {
                    generator.writeEnd().close();
                    if (temp % 20 == 0) {
                        fName++;
                        if (skuRowCount != metadataRowCountSku) {
                            writer = new FileWriter(System.getProperty("user.dir") + "\\" + jsonFolderGenPath + "\\Sku1k_" + fName + ".json");  //write generated json to jsonFolderGenPath
                            generator = Json.createGenerator(writer);
                            generator.writeStartArray();
                        } else if (skuRowCount == metadataRowCountSku) {
                            // generator.writeEnd().close();
                            // break;
                        }
                    }

                    temp = 0;
                } else if (skuRowCount == metadataRowCountSku) {
                    generator.writeEnd().close();
                }

            } // Sku sheet for


        }
    }
}
