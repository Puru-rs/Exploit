package utilities;

import com.google.gson.*;

import com.jayway.restassured.RestAssured;
import com.jayway.restassured.http.ContentType;
import com.jayway.restassured.response.Header;
import com.jayway.restassured.response.Headers;
import com.jayway.restassured.response.Response;

import org.apache.poi.hssf.usermodel.HSSFSheet;

import java.time.Instant;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.regex.Pattern;

import static com.jayway.restassured.config.EncoderConfig.encoderConfig;

/**
 * Created by harshithgn on 12/8/2017.
 */
@SuppressWarnings("ALL")
public class RestAssuredCall {
    RiversandMaster objRiversandMaster = new RiversandMaster();
    MailEngine objMailEngine = new MailEngine();
    ReadConfig objReadConfig = new ReadConfig();
    HSSFSheet sheet = null;
    List<Header> headerList = new LinkedList<Header>();
    int actualCount;
    Gson gsonObject = new Gson();
    JsonObject jsonObject;
    long progEndTime;
    int testCaseExeTime;
    int excelProgEndTime;
    boolean dataObjOperationResponse;
    List<String> mailRecipients = new ArrayList<String>();


    public int callRestAssured(String caseNo, int poolingInterval, List<String> requestBuilder, long progStartTime, List<String> queryBuilder, String logFileName) throws Exception {

        mailRecipients = mailRecipients = objReadConfig.getMailRecipients(0);
        sheet = objRiversandMaster.readExcelWorkbook("inputFiles\\Master.xls", "JSON Data");
        String headers = requestBuilder.get(1).trim();      // headers
        String url = requestBuilder.get(2).trim();          //api url
        String request = requestBuilder.get(3).trim();      //request body
        String[] headerAry = headers.split(Pattern.quote("||"));   //split headers cell based on ||
        for (String oneHeader : headerAry) {   //iterate through each header
            String[] oneHeaderSplit = oneHeader.split(Pattern.quote(":"));   //split based on : for each headers
            Header addHeader = new Header(oneHeaderSplit[0].toString().trim(), oneHeaderSplit[1].toString().trim());
            headerList.add(addHeader); // add each headers to the headers list

        }
        Headers completeHeaders = new Headers(headerList);
        objRiversandMaster.logStatus(logFileName, request);
        System.out.println(request);

        Response r1 = RestAssured.given().config(RestAssured.config().encoderConfig(encoderConfig().encodeContentTypeAs("Content-Type:application/json", ContentType.TEXT))).headers(completeHeaders).
                body(request).
                when().
                post(url);
        String fBody = r1.getBody().asString();
        objRiversandMaster.logStatus(logFileName, fBody);
        System.out.println(fBody);

        jsonObject = gsonObject.fromJson(fBody, JsonObject.class);
        dataObjOperationResponse = fBody.contains("dataObjectOperationResponse");

        if (dataObjOperationResponse) {
            Gson gson = new GsonBuilder().setPrettyPrinting().create();
            JsonParser jp = new JsonParser();
            JsonElement je = jp.parse(fBody);
            String prettyJsonString = gson.toJson(je);
            objMailEngine.failureMail(mailRecipients, prettyJsonString);

        } else {
            excelProgEndTime = Integer.parseInt(queryBuilder.get(6));

            do {
                Thread.sleep(poolingInterval);
                Response r2 = RestAssured.given().config(RestAssured.config().encoderConfig(encoderConfig().encodeContentTypeAs("Content-Type:application/json", ContentType.TEXT))).headers(completeHeaders).
                        body(request).
                        when().
                        post(url);
                String body = r2.getBody().asString();
                objRiversandMaster.logStatus(logFileName, body);
                System.out.println(body);

                jsonObject = gsonObject.fromJson(body, JsonObject.class);
                actualCount = jsonObject.getAsJsonObject("response").getAsJsonPrimitive("totalRecords").getAsInt();
                progEndTime = Instant.now().getEpochSecond();
                testCaseExeTime = calTime(progStartTime, progEndTime);
                objRiversandMaster.logStatus(logFileName, caseNo + " - " +actualCount);
                System.out.println(caseNo + " - " +actualCount);
            }
            while (!((actualCount >= Integer.parseInt(requestBuilder.get(4))) || (testCaseExeTime >= excelProgEndTime)));
        }

        return actualCount;
    }

    public int calTime(long startTime, long endTime){
        long lStartTime = startTime;
        long lEndTime = endTime;
        long output = lEndTime - lStartTime;
        int execInMin = (int) (output / 60);
        return execInMin;
    }
}
